import{s as O}from"./index-Dg6Yshyy.js";import{_ as T,u as z,r as w,k as j,w as G,o as D,a as t,c as b,e as P,t as y,d as E,F as M,l as V,v as R}from"./index-BHkq7fOf.js";import{a as k}from"./axios-DsPaXkF5.js";const W={setup(){const n=z(),l=w([]),p=w([]),r=w([]),x=w(""),F=async(s,a,e)=>{const i=s.target.files[0];if(i){const o=new FileReader;o.onload=async f=>{l.value[a][e]=f.target.result;const m=new FormData;m.append("file",i);try{if((await k.post("/api/check-font",m,{headers:{"Content-Type":"multipart/form-data"}})).data.isFont)if(e==="front"){const _=await k.post("/api/process-upload",m,{headers:{"Content-Type":"multipart/form-data"}});_.data.status==="success"?(I(_.data.detections[0].message,a),n.add({severity:"success",summary:"Upload Success",detail:"File uploaded and processed successfully!",life:3e3})):_.data.status==="warning"?(I(_.data.new_data,a),n.add({severity:"warn",summary:"Upload Warning",detail:"File uploaded with warnings. Please check!",life:3e3})):(v(a,e),n.add({severity:"error",summary:"Upload Error",detail:"Please select a clearer image for accurate information!",life:5e3}))}else v(a,e),n.add({severity:"error",summary:"Upload Error",detail:"Back image is not suitable, please choose another one!",life:5e3});else e==="front"&&(v(a,e),n.add({severity:"error",summary:"Upload Error",detail:"Please select a clearer image for accurate information!",life:5e3}))}catch(h){console.error("Error uploading file:",h),v(a,e),n.add({severity:"error",summary:"Upload Failed",detail:"Failed to upload the file. Please try again.",life:3e3})}},o.readAsDataURL(i)}},v=(s,a)=>{l.value[s][a]=null;const e=document.getElementById(`${a}-upload-${s}`);e&&(e.value="")},d=(s,a)=>s===a?'<span class="text-green-500">Match</span>':'<span class="text-red-500">Not Match</span>',c=()=>{let s=!0;for(let a=0;a<l.value.length;a++){const e=l.value[a];(!e.front||!e.back)&&(s=!1,n.add({severity:"warn",summary:"Incomplete Uploads",detail:`Please upload both front and back images for ${e.type} ${a+1}.`,life:5e3}))}s&&n.add({severity:"success",summary:"All Good",detail:"All images are uploaded. You can now proceed.",life:3e3})},u=s=>{const{insured:a,buyer:e,dependents:i}=s;p.value=[{...a,type:"Insured"},{...e,type:"Buyer"},...i.map(o=>({...o,type:"Dependent"}))],l.value=[{...a,type:"Insured",front:null,back:null},{...e,type:"Buyer",front:null,back:null},...i.map(o=>({...o,type:"Dependent",front:null,back:null}))],r.value=l.value.map(o=>{var f;return{NationalID:{oldData:o.nationalID,newData:""},CitizenID:{oldData:o.citizenID,newData:""},DateOfBirth:{oldData:g(o.dateOfBirth),newData:""},FullName:{oldData:o.fullName,newData:""},Address:{oldData:o.address,newData:""},Gender:{oldData:((f=o.gender)==null?void 0:f.name)||"",newData:""}}})},g=s=>{if(!s||s.length!==8)return s;const a=s.slice(0,2),e=s.slice(2,4),i=s.slice(4);return`${a}/${e}/${i}`},I=(s,a)=>{var o,f,m,h,_,C,N,B;const e=l.value[a],i={NationalID:{oldData:((o=p.value[a])==null?void 0:o.nationalID)||"",newData:s.id_identity_card||e.nationalID},CitizenID:{oldData:((f=p.value[a])==null?void 0:f.citizenID)||"",newData:s.id_passport||e.citizenID},DateOfBirth:{oldData:((m=p.value[a])==null?void 0:m.dateOfBirth)||"",newData:g(s.birth_date)||e.dateOfBirth},FullName:{oldData:((h=p.value[a])==null?void 0:h.fullName)||"",newData:s.fullname||e.fullName},Address:{oldData:((_=p.value[a])==null?void 0:_.address)||"",newData:s.address||e.address},Gender:{oldData:((N=(C=p.value[a])==null?void 0:C.gender)==null?void 0:N.name)||"",newData:s.gender||((B=e.gender)==null?void 0:B.name)||""}};r.value[a]=i},A=async()=>{const s=l.value.map((e,i)=>{var m;const f={...p.value.find(h=>h.id===e.id)||{},...(m=r.value[i])==null?void 0:m.newData};return{id:e.id,[e.type.toLowerCase()]:f}}),a={insured:s.find(e=>e.insured),buyer:s.find(e=>e.buyer),dependents:s.filter(e=>e.dependents).map(e=>e.dependents).flat()};try{(await k.post("/v4/api/fortest",{updatedData:a,notes:x.value})).data.status==="success"?n.add({severity:"success",summary:"Update Success",detail:"Data updated successfully!",life:3e3}):n.add({severity:"warn",summary:"Update Warning",detail:"Data update with warnings. Please check!",life:3e3})}catch(e){console.error("Error updating data:",e),n.add({severity:"error",summary:"Update Failed",detail:"Failed to update data. Please try again.",life:3e3})}},L=async s=>{try{if(!s)n.add({severity:"warn",summary:"Missing ID",detail:"CMI_ID is missing. Please provide a valid ID.",life:3e3});else{const a=await k.get(`/v4/api/fortest/${s}`);u(a.data)}}catch(a){console.error("Failed to load buyer:",a),n.add({severity:"error",summary:"Data Load Error",detail:"Failed to load data. Please try again later.",life:3e3})}},U=sessionStorage.getItem("CMI_ID");return U&&L(U),{people:l,comparisonData:r,notes:x,handleUpload:F,compareFields:d,validateUploads:c,sendUpdatedData:A}}},H={class:"flex flex-col gap-8"},S={class:"card flex-1 flex flex-col gap-4 p-4"},Y={class:"font-semibold text-xl"},$={class:"font-semibold text-xl"},q={class:"grid grid-cols-2 gap-4"},J={class:"flex flex-col gap-2"},K=["for"],Q=["id","onChange"],X={class:"flex flex-col gap-2"},Z=["for"],ee=["id","onChange"],ae={class:"flex items-center justify-center"},te={key:0,class:"w-full h-auto"},se=["src"],oe={class:"flex items-center justify-center"},le={key:0,class:"w-full h-auto"},re=["src"],de={class:"card flex-1 flex flex-col gap-4 p-4"},ne={class:"font-semibold text-xl"},ce={class:"min-w-full mt-4 border-separate border-spacing-2 border border-gray-300"},ie=t("thead",null,[t("tr",null,[t("th",{class:"border border-gray-400 px-4 py-2"},"Field"),t("th",{class:"border border-gray-400 px-4 py-2"},"Old Data"),t("th",{class:"border border-gray-400 px-4 py-2"},"New Data"),t("th",{class:"border border-gray-400 px-4 py-2"},"Comparison")])],-1),ue={class:"border border-gray-300 px-4 py-2"},pe={class:"border border-gray-300 px-4 py-2"},fe={class:"border border-gray-300 px-4 py-2"},me=["innerHTML"],ye={class:"card flex flex-col gap-4 p-4"},he=t("div",{class:"font-semibold text-xl"},"Notes",-1),_e={class:"flex flex-col gap-2"},De=t("label",{for:"notes",class:"font-medium"},"Notes",-1),ve={class:"card flex flex-col gap-4 p-4"};function be(n,l,p,r,x,F){const v=O;return D(),j(v,null,{default:G(()=>[t("div",H,[(D(!0),b(M,null,P(r.people,(d,c)=>(D(),b("div",{key:c,class:"flex flex-col md:flex-row gap-8 mb-8"},[t("div",S,[t("div",Y,y(c+1)+". Upload ID Cards for "+y(d.type),1),t("div",$,y(d.fullName),1),t("div",q,[t("div",J,[t("label",{for:"front-upload-"+c,class:"font-medium"},"Upload Front Side",8,K),t("input",{id:"front-upload-"+c,type:"file",accept:"image/*",onChange:u=>r.handleUpload(u,c,"front"),class:"border rounded p-2"},null,40,Q)]),t("div",X,[t("label",{for:"back-upload-"+c,class:"font-medium"},"Upload Back Side",8,Z),t("input",{id:"back-upload-"+c,type:"file",accept:"image/*",onChange:u=>r.handleUpload(u,c,"back"),class:"border rounded p-2"},null,40,ee)]),t("div",ae,[d.front?(D(),b("div",te,[t("img",{src:d.front,width:"250",class:"object-cover border rounded"},null,8,se)])):E("",!0)]),t("div",oe,[d.back?(D(),b("div",le,[t("img",{src:d.back,width:"250",class:"object-cover border rounded"},null,8,re)])):E("",!0)])])]),t("div",de,[t("div",ne,"Compare Data for "+y(d.type)+" "+y(c+1),1),t("table",ce,[ie,t("tbody",null,[(D(!0),b(M,null,P(r.comparisonData[c],(u,g)=>(D(),b("tr",{key:g},[t("td",ue,y(g),1),t("td",pe,y(u.oldData),1),t("td",fe,y(u.newData),1),t("td",{class:"border border-gray-300 px-4 py-2",innerHTML:r.compareFields(u.oldData,u.newData)},null,8,me)]))),128))])])])]))),128)),t("div",ye,[he,t("div",_e,[De,V(t("textarea",{id:"notes",rows:"6","onUpdate:modelValue":l[0]||(l[0]=d=>r.notes=d),placeholder:"Add any additional notes here",class:"border rounded p-2"},null,512),[[R,r.notes]])])]),t("div",ve,[t("button",{onClick:l[1]||(l[1]=(...d)=>r.validateUploads&&r.validateUploads(...d)),class:"btn btn-primary"},"Cập nhật"),t("button",{onClick:l[2]||(l[2]=(...d)=>r.sendUpdatedData&&r.sendUpdatedData(...d)),class:"btn btn-success"},"Gửi Cập Nhật")])])]),_:1})}const xe=T(W,[["render",be]]);export{xe as default};
